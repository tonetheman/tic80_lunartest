local dt = 0
local pt = 0
local velclamp = 20
local W = 240
local H = 136
local GRAV_FORCE = 9.8
local current_scene = nil
local Player = {}
local MenuScene = {}
local GameScen = {}

function Player.new(x,y)
	local self = {}
	self.x = x
	self.y = y
	self.velx= 0
	self.vely = 0

	-- could make these local to update
	-- maybe later
	self.rotation = 90 -- really not needed anymore
	self.angle_radians = math.rad(self.rotation)
	
	self.thrust = 30
	function self:bounds()
		-- bounds check
		if self.x>W then
			self.x = 0
		end
		if self.x<0 then
			self.x = W
		end
		if self.y>H then
			self.y = 0
		end
		if self.y<0 then
			self.y = H
		end		
	end
	function self:set_rotation(degrees)
		self.rotation = degrees
		self.angle_radians = math.rad(self.rotation)
	end
	function self:update(dt)
		self.up = false
		self.down = false
		self.left = false
		self.right = false

		-- start of stupid simple
		-- collision handling
		function solidbelow(x,y)
			-- currently 32 is solid
			-- trace(x//8 .. " " .. y//8)
			return mget(x//8,(y+8)//8) == 32
		end
		function solidright(x,y)
			return mget((x+8)//8,(y)//8) == 32
		end
		function solidleftorup(x,y)
			return mget((x)//8,(y)//8) == 32
		end
		-- where are we moving
		local posx = self.x + self.velx*dt
		local posy = self.y + self.vely*dt
		  
		if solidbelow(posx,posy) then
			-- trace("hit")
			-- trace(posx//8 .. " " .. posy//8)
			if self.vely > 5 then
				trace("boom")
			end
			self.velx = 0
			self.vely = 0
		elseif solidright(posx,posy) or solidleftorup(posx,posy) then
			self.velx = 0
		else
			-- move it
			self.x = posx
			self.y = posy
		end


		-- bounds checking
		self:bounds()
		--up
		if btn(0) then
			self.up = true
			self:set_rotation(90)
			local forcex = math.cos(self.angle_radians)*self.thrust*dt
			local forcey = math.sin(self.angle_radians)*self.thrust*dt
			self.velx = self.velx - forcex
			self.vely = self.vely - forcey
		end
		--down
		if btn(1) then
			self.down = true
			self:set_rotation(90)
			local forcex = math.cos(self.angle_radians)*self.thrust*dt
			local forcey = math.sin(self.angle_radians)*self.thrust*dt
			self.velx = self.velx + forcex
			self.vely = self.vely + forcey
		end
		-- left
		if btn(2) then
			self.left = true
			self:set_rotation(180)
			local forcex = math.cos(self.angle_radians)*self.thrust*dt
			local forcey = math.sin(self.angle_radians)*self.thrust*dt
			self.velx = self.velx + forcex
			self.vely = self.vely + forcey
		end
		-- right
		if btn(3) then
			self.right = true
			self:set_rotation(180)
			local forcex = math.cos(self.angle_radians)*self.thrust*dt
			local forcey = math.sin(self.angle_radians)*self.thrust*dt
			self.velx = self.velx - forcex
			self.vely = self.vely - forcey
		end

		-- apply grav no matter what
		self.vely = self.vely + GRAV_FORCE*dt

		-- clamp velocity
		
		if math.abs(self.velx)>velclamp then
			if self.velx>0 then
				self.velx = velclamp
			else
				self.velx = -velclamp
			end
		end
		if math.abs(self.vely)>velclamp then
			if self.vely>0 then
				self.vely = velclamp
			else
				self.vely = -velclamp
			end
		end
		
	end
	function self:draw()
		local sprnum = 1
		local msg = ""
		if self.up then
			sprnum = 2
			msg = "up"
		elseif self.down then
			sprnum = 5
			msg = "down"
		elseif self.left then
			sprnum = 3
			msg = "left"
		elseif self.right then
			sprnum = 4
			msg = "right"
		else
			sprnum = 1
			-- neutral
		end

		-- debug
		pix(self.x,self.y,6)
        pix(self.x+8,self.y+8,6)
        pix(self.x+8,self.y,6)
        pix(self.x,self.y+8,6)

		-- real sprite
		spr(sprnum,self.x,self.y,
		0, -- color key (transparent color)
		1, -- scale
		0, -- flip
		0, -- rotate
		1,1) -- width and height
		print(msg)
	end
	return self
end

function MenuScene.new()
	local self = {}
	function self:enter()
	end
	function self:exit()
	end
	function self:update()
	end
	function self:draw()
	end
	return self
end

--[[
	TODO: what is wrong with self
	changed to selfi and it worked?
	is that special in the enter?
	does not make sense
]]
function GameScen.new()
	local selfi = {}
	selfi.player = nil
	-- self.player = Player.new(80,80)
	function selfi:enter()
		-- trace("enter")
		selfi.player = Player.new(80,80)
		-- trace("enter finished")
	end
	function selfi:exit()
	end
	function selfi:update(dt)
		self.player:update(dt)
	end
	function selfi:draw()
		cls(0)
		map(0,0,25,15)
		self.player:draw()
	end
	return selfi
end

function update(dt)
	-- trace("update")
	current_scene:update(dt)
end

function draw()
	current_scene:draw()
end

function init()
	trace("init started")
	local s = GameScen.new()
	current_scene = s
	current_scene.enter()
	trace("init stopped")
end
init()

function TIC()
    -- calculate delta time
    dt=time()-pt
	pt=time()
	-- trace(tostring(dt))
	update(dt/1000)
	draw()
end
-- <TILES>
-- 001:000000000000000000000000000aa00000aaaa000aaaaaa00aaaaaa0aaaaaaaa
-- 002:000000000000000000000000000aa00000aaaa000aaaaaa00aaaaaa0aaaeeaaa
-- 003:000000000000000000000000000aa00000eaaa000aaaaaa00aaaaaa0aaaaaaaa
-- 004:000000000000000000000000000aa00000aaae000aaaaaa00aaaaaa0aaaaaaaa
-- 005:000000000000000000000000000ee00000aaaa000aaaaaa00aaaaaa0aaaaaaaa
-- 008:00000000000000000000000a000000aa00000aaa00000aaa00000aaa0000aaaa
-- 009:0000000000000000a0000000aa000000aaa00000aaa00000aaa00000aaee0000
-- 024:0000aaaa0000aaaa0000aaaa0000aaaa000aaaaa00aaaaaaaaaaaaaaaaaaaaaa
-- 025:aaaa0000aaaa0000aaaa0000aaaa0000aaaaa000aaaaaa00aaaaaaaaaaaaaaaa
-- 032:bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
-- </TILES>

-- <MAP>
-- 000:020202020202000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:021212120000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:021212120000000202000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:021212120000000202000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:021212120000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:021212120000000000000000000000000000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:021212121200000000000000000000000000020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:021212121200000000000000020202000000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:021212121200000000000000000000000000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:021212121212120000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:021212121212120000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:020000000000000000000000000002020200000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:020000000000000000000000000002000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:020000000000000000000000000002000000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <PALETTE>
-- 000:140c1c44243430346d4e4a4e854c30346524d04648757161597dced27d2c8595a16daa2cd2aa996dc2cadad45edeeed6
-- </PALETTE>

